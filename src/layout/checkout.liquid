<!DOCTYPE html>
<html lang="{{ locale }}" dir="{{ direction }}" class="{{ checkout_html_classes }}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, user-scalable=0">
    <meta name="referrer" content="origin">

    {% include 'google-tag-manager' %}
    {%- assign titleWords = page_title | split: ' ' -%}
    {% capture page_title %}{% for word in titleWords %}{{ word | capitalize }} {% endfor %}{% endcapture %}
    <title>{{ shop.name }} - {{ page_title | rstrip }}</title>

    {{ content_for_header }}
  
    {{ checkout_stylesheets }}
    {{ 'checkout.scss.css' | asset_url | stylesheet_tag }} 

    {{ checkout_scripts }}
  </head>
  <body>
    
    {% include 'google-tag-manager-noscript' %}

    <div class="banner" data-header>
      <div class="wrap">
        {{ content_for_logo }}
      </div>
    </div>

    {{ order_summary_toggle }}

    <div class="content" data-content>
      <div class="wrap">
        <div class="sidebar" role="complementary">
          <div class="sidebar__header">
            {{ content_for_logo }}
          </div>
          <div class="sidebar__content">
            {{ content_for_order_summary }}
          </div>
        </div>
        <div class="main" role="main">
          <div class="main__header">
            {{ content_for_logo }}
            {{ breadcrumb }}
            {{ alternative_payment_methods }}
          </div>
          <div class="main__content">
            {{ content_for_layout }}
          </div>
          <div class="main__footer">
            {{ content_for_footer }}
          </div>
        </div>
      </div>
    </div>
    {{ tracking_code }}

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
    <script>
      jQuery(document).ready(function($){
        var formatProductNames = function(){
          $('.product__description__name').each(function(){
            var name = $(this).text();
            var nameParts = name.split(' - ');
            $(this).text(nameParts[0].replace('The ', ''));
            var options = [nameParts[1], nameParts[2]];
            if( $(this).next('.product__description__variant').text() != '' ){
              options.push($(this).next('.product__description__variant').text());
            }
            $(this).next('.product__description__variant').text(options.join(' / '));
          });
          $('table.product-table').addClass('in');
        }

        if (window.MutationObserver) { // format our titles when they become available
          var targetNodes         = $(".sidebar__content");
          var MutationObserver    = window.MutationObserver || window.WebKitMutationObserver;
          var myObserver          = new MutationObserver (mutationHandler);
          var obsConfig           = { childList: true, characterData: true, attributes: true, subtree: true };

          //--- Add a target node to the observer. Can only add one node at a time.
          targetNodes.each ( function () {
              myObserver.observe (this, obsConfig);
          } );

          function mutationHandler (mutationRecords) {
            mutationRecords.forEach ( function (mutation) {
                if( mutation.type == "childList" ){
                  if( mutation.target == $('table.product-table')[0] ){
                    formatProductNames();
                  }
                }
            } );
          }
        }else{
          $('table.product-table').addClass('in'); // just show the cart contents unformatted
        }

        if( Shopify.Checkout.step != 'contact_information' ){
          // titles are available on page load
          formatProductNames();
        }

      });
    </script>
  </body>
</html>
